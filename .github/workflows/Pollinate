name: Pollinate - AI Feature Implementation

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  pollinate:
    runs-on: ubuntu-latest
    if: startsWith(github.event.comment.body, '!Pollinate')
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Parse feature request
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          FEATURE_DESC=$(echo "$COMMENT" | sed 's/^!Pollinate//' | xargs)
          echo "feature_description=$FEATURE_DESC" >> $GITHUB_OUTPUT
          BRANCH_NAME="pollinate/$(echo "$FEATURE_DESC" | head -c 30 | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed 's/[^a-z0-9-]//g')-$(date +%s)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Create feature branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.parse.outputs.branch_name }}

      - name: Call AI to implement feature
        id: ai_implement
        run: |
          PROMPT="You are implementing a feature for a GitHub repository.

          Feature request: ${{ steps.parse.outputs.feature_description }}

          Analyze the repository structure and implement this feature. Output your response as a JSON array of file operations:
          [
            {
              \"action\": \"create\" | \"modify\" | \"delete\",
              \"path\": \"relative/file/path\",
              \"content\": \"file content here (for create/modify)\"
            }
          ]

          Only output the JSON array, nothing else."
          
          # Call Pollinations AI API
          RESPONSE=$(curl -s https://enter.pollinations.ai/api/generate/openai \
            -H "content-type: application/json" \
            -H "authorization: Bearer HnmNucebqbTDorAfFAkbBGUOYzQVHTcEdHdKKGQQIosjgMativUHGRrUxlYpmKGC" \
            -d "{
              \"messages\": [
                {
                  \"role\": \"user\",
                  \"content\": $(echo "$PROMPT" | jq -Rs .)
                }
              ],
              \"model\": \"openai\",
              \"jsonMode\": true
            }")
          
          echo "$RESPONSE" | jq -r '.choices[0].message.content' > changes.json
          echo "AI response saved to changes.json"

      - name: Apply changes
        run: |
          node << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          const changes = JSON.parse(fs.readFileSync('changes.json', 'utf8'));
          
          for (const change of changes) {
            const filePath = change.path;
            const dir = path.dirname(filePath);
            
            if (change.action === 'create' || change.action === 'modify') {
              if (!fs.existsSync(dir)) {
                fs.mkdirSync(dir, { recursive: true });
              }
              fs.writeFileSync(filePath, change.content);
              console.log(`${change.action}: ${filePath}`);
            } else if (change.action === 'delete') {
              if (fs.existsSync(filePath)) {
                fs.unlinkSync(filePath);
                console.log(`deleted: ${filePath}`);
              }
            }
          }
          EOF

      - name: Commit changes
        run: |
          git add .
          git commit -m "ðŸŒ± Pollinate: ${{ steps.parse.outputs.feature_description }}" || echo "No changes to commit"
          git push origin ${{ steps.parse.outputs.branch_name }}

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --title "ðŸŒ± Pollinate: ${{ steps.parse.outputs.feature_description }}" \
            --body "This PR was automatically generated by the Pollinate action.
          
          **Feature Request:** ${{ steps.parse.outputs.feature_description }}
          **Requested by:** @${{ github.event.comment.user.login }}
          **Original Issue:** #${{ github.event.issue.number }}
          
          Please review the changes carefully before merging." \
            --base main \
            --head ${{ steps.parse.outputs.branch_name }})
          
          echo "pr_url=$PR_URL" >> $GITHUB_ENV

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸŒ± **Pollinate activated!**\n\nI've implemented your feature request and created a pull request.\n\nCheck it out: ${process.env.pr_url}`
            })
